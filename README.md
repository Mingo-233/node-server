# 停车提醒服务器 🚗

一个智能的停车时间提醒服务，当停车时间超过设定阈值时自动发送通知。

## ✨ 功能特性

- 🔄 **自动重启**: 使用 PM2 进程管理，服务崩溃时自动重启
- 📱 **Bark通知**: 集成 Bark 推送服务，及时发送停车提醒
- ⚡ **任务队列**: 智能任务队列管理，支持多个定时任务
- 🛡️ **错误处理**: 完善的错误处理机制，确保服务稳定性
- 📊 **日志管理**: 详细的日志记录和分类存储
- 🚀 **一键启动**: 简单的启动脚本，自动安装依赖

## 🚀 快速开始

### 方法一：一键启动（推荐）

```bash
./start.sh
```

### 方法二：手动启动

1. 安装依赖
```bash
pnpm install
# 或
npm install
```

2. 使用 PM2 启动服务
```bash
npm run pm2:start
```

3. 或直接运行
```bash
npm start
```

## 📋 可用脚本

| 命令 | 说明 |
|------|------|
| `npm start` | 直接启动服务 |
| `npm run dev` | 开发模式启动（文件变化自动重启） |
| `npm run pm2:start` | 使用 PM2 启动服务 |
| `npm run pm2:stop` | 停止 PM2 服务 |
| `npm run pm2:restart` | 重启 PM2 服务 |
| `npm run pm2:delete` | 删除 PM2 服务 |
| `npm run pm2:logs` | 查看服务日志 |
| `npm run pm2:monit` | 监控服务状态 |

## 🌐 API 端点

### 启动停车提醒
```
GET http://127.0.0.1:3123/notify
```
- 启动两个定时任务：50分钟和110分钟提醒
- 返回任务添加状态

### 测试通知
```
GET http://127.0.0.1:3123/mock
```
- 测试 Bark 通知服务是否正常
- 返回通知发送结果

## 🔧 配置说明

### 时间配置
```javascript
const MIN_TIME_50 = 50 * 60 * 1000    // 50分钟
const MAX_TIME_110 = 110 * 60 * 1000  // 110分钟
```

### Bark 推送配置
```javascript
const BARK_URL = 'https://api.day.app/vVEfUA68tfzDjNgADBMVZ6/'
```

## 📊 监控和日志

### 查看服务状态
```bash
pm2 status
```

### 查看实时日志
```bash
pm2 logs parking-server
```

### 监控面板
```bash
pm2 monit
```

### 日志文件位置
- 错误日志: `./logs/err.log`
- 输出日志: `./logs/out.log`
- 合并日志: `./logs/combined.log`

## 🛡️ 错误处理和自动恢复

### 自动重启策略
- 应用崩溃时自动重启
- 最大重启次数：10次
- 重启延迟：4秒
- 最小运行时间：10秒

### 内存管理
- 内存使用超过 1GB 时自动重启
- 防止内存泄漏导致系统不稳定

### 错误监控
- 未捕获异常处理
- Promise 拒绝处理
- 优雅关闭机制

## 🔄 进程管理

PM2 提供了完整的进程生命周期管理：

1. **自动重启**: 进程崩溃时自动重启
2. **日志管理**: 自动轮转和归档日志
3. **监控面板**: 实时监控 CPU 和内存使用
4. **集群模式**: 支持多进程部署（当前配置为单进程）

## 🚨 故障排查

### 服务无法启动
1. 检查端口 3123 是否被占用
2. 查看错误日志：`pm2 logs parking-server --err`
3. 检查依赖是否正确安装

### 通知发送失败
1. 检查网络连接
2. 验证 Bark URL 配置
3. 查看应用日志中的错误信息

### 队列任务异常
1. 查看队列状态日志
2. 检查任务执行错误信息
3. 必要时重启服务：`pm2 restart parking-server`

## 📝 更新日志

### v1.0.0
- ✅ 修复了原有的错误处理问题
- ✅ 添加了 PM2 进程管理
- ✅ 改进了队列任务错误处理
- ✅ 添加了详细的日志记录
- ✅ 实现了自动重启机制
- ✅ 提供了一键启动脚本

## 🤝 贡献

欢迎提交 Issue 和 Pull Request 来改进这个项目！
